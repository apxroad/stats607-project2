# =========================
# Stats 607 Project Makefile
# =========================
SHELL := /bin/bash

# ---- Global knobs (central place to tweak) ----
PY      := python
SEED    := 2025
BASE    := uniform
ALPHA   := 5
TVALS   := 0.25 0.5 0.75

# Part A panel ns (include 0 for the "prior" panel)
PARTA_NS := 0 100 500 1000

# Output dirs
RAW_DIR      := results/raw
FIG_DIR      := results/figures
SUMMARY_DIR  := results/summary

# Convenience stem used by Part B figures/logs
PARTB_STEM := partB_n1000_a$(ALPHA)_seed$(SEED)_$(BASE)

# ------------------------
# Phony targets
# ------------------------
.PHONY: all simulate analyze figures clean test help everything

# Full pipeline, as required by rubric
all: clean simulate analyze figures

# Keep your old alias too (niceness)
everything: all

# ------------------------
# Simulate: generate RAW outputs only
# ------------------------
simulate:
	@mkdir -p $(RAW_DIR)
	@echo "[simulate] Part B: distances + Pm paths"
	$(PY) -m src_cli.partb_log_convergence --n 1000 --alpha $(ALPHA) --t $(TVALS) --seed $(SEED) --base $(BASE)
	@echo "[simulate] Part C: prop 2.6 pooled-Z (logs)"
	$(PY) -m src_cli.partc_log_prop26 --alpha $(ALPHA) --t $(TVALS) --n 100 500 1000 --M 400 --seed $(SEED) --base $(BASE)

# ------------------------
# Analyze: summarize raw results (tidy CSVs)
# ------------------------
analyze: simulate
	@mkdir -p $(SUMMARY_DIR)
	@echo "[analyze] summarizing Part C -> $(SUMMARY_DIR)/prop26_summary.csv"
	$(PY) - <<PY
import pandas as pd, pathlib, os
pathlib.Path("$(SUMMARY_DIR)").mkdir(parents=True, exist_ok=True)

# ---- Prop 2.6 summary (coverage/width by n,t) ----
p = "$(RAW_DIR)/prop26_M400_L50000_a$(ALPHA)_seed$(SEED)_$(BASE).csv"
if os.path.exists(p):
    df = pd.read_csv(p)
    # 'covered' is 0/1, 'width' numeric
    out = (df.groupby(["n","t"])
             .agg(coverage=("covered","mean"),
                  mean_width=("width","mean"),
                  reps=("rep","nunique"))
             .reset_index())
    out.to_csv("$(SUMMARY_DIR)/prop26_summary.csv", index=False)
    print("[ok] wrote $(SUMMARY_DIR)/prop26_summary.csv")
else:
    print("[skip] missing", p)

# ---- Part B distances quick summary ----
p2 = "$(RAW_DIR)/distances_$(PARTB_STEM).csv"
if os.path.exists(p2):
    d  = pd.read_csv(p2)
    sm = d.agg({"d_infty":["mean","min","max"], "d_rmse":["mean","min","max"]})
    sm.to_csv("$(SUMMARY_DIR)/partB_distances_summary.csv")
    print("[ok] wrote $(SUMMARY_DIR)/partB_distances_summary.csv")
else:
    print("[skip] missing", p2)
PY

# ------------------------
# Figures: produce ALL required plots (publication-quality)
# ------------------------
figures:
	@mkdir -p $(FIG_DIR)
	@echo "[figures] Part A panels"
	@for n in $(PARTA_NS); do \
	  $(PY) -m src_cli.parta_panels --base $(BASE) --t $(TVALS) --alpha 1 5 20 --n $$n --M 4000 --N 2000 --seed $(SEED); \
	done
	@echo "[figures] Part B (convergence, predictive paths)"
	$(PY) -m src_cli.partb_figures --stem $(PARTB_STEM) --title "n=1000, α=$(ALPHA), base=$(BASE)"
	@echo "[figures] Part C (pooled Z only)"
	$(PY) -m src_cli.partc_figures_prop26 --csv $(RAW_DIR)/prop26_M400_L50000_a$(ALPHA)_seed$(SEED)_$(BASE).csv --title "Proposition 2.6: α=$(ALPHA), base=$(BASE)"

# ------------------------
# Clean: remove generated artifacts
# ------------------------
clean:
	@echo "[clean] removing results and caches"
	@rm -rf $(RAW_DIR)* $(FIG_DIR)* $(SUMMARY_DIR)* .pytest_cache __pycache__
	@mkdir -p $(RAW_DIR) $(FIG_DIR) $(SUMMARY_DIR)

# ------------------------
# Test suite
# ------------------------
test:
	pytest -q

# ------------------------
# Help
# ------------------------
help:
	@echo "Targets:"
	@echo "  make all       - clean → simulate → analyze → figures (full pipeline)"
	@echo "  make simulate  - run simulations and save RAW outputs"
	@echo "  make analyze   - process RAW outputs into summary CSVs"
	@echo "  make figures   - create all visualizations"
	@echo "  make clean     - remove generated files"
	@echo "  make test      - run pytest"
	@echo "  make help      - this message"
